import { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { useParams, useSearchParams } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { useQueryClient } from '@tanstack/react-query';
import { SteppedForm, FieldType, FormStep } from '@shared/components';
import type { Duration } from '@shared/components';
import { itemStepSchemasEdit } from '@shared/validation/schemas';
import { getStepFromUrl } from '@shared/components/forms/steppedForm/utils';
import {
  useItem,
  useMusicCategories,
  useMusicSubCategories,
  usePhotoCategories,
  usePhotoSubCategories,
  useMusicGenres,
  useGenres,
  useUpdateItemMutation,
  useAddOns,
  useDeleteAddOnMutation,
  useStudio,
  useCategories
} from '@shared/hooks';
import { createAddOnsBatch, updateAddOn } from '@shared/services';
import { Item } from 'src/types/index';
import { toast } from 'sonner';
import { CreateAddOnForm, PendingAddOn } from '@features/entities/addOns/forms';
import { isFeatureEnabled } from '@core/config/featureFlags';
import { clearAllFormData } from '@shared/utils/formAutoSaveUtils';
import {
  OfferIcon,
  InfoOutlinedIcon,
  CalendarIcon,
  EventAvailableIcon,
  BoltIcon,
  HourglassIcon,
  CategoryIcon,
  LibraryMusicIcon,
  InventoryIcon,
  UploadIcon,
  PublicIcon
} from '@shared/components/icons';
import './_createItemForm.scss';
import { ITEM_NAME_MAX, ITEM_DESCRIPTION_MAX } from '@shared/constants/fieldLimits';

interface ItemFormData {
  imageUrl?: string;
  categories?: string[];
  subCategories?: string[];
  genres?: string[];
  studioId?: string;
  pricePer?: string;
  instantBook?: boolean | string;
  city?: string;
  languageToggle?: string;
  // Booking Settings
  minimumBookingDuration?: Duration;
  minimumQuantity?: number;
  advanceBookingRequired?: Duration;
  preparationTime?: Duration;
  // Remote Settings
  remoteService?: boolean;
  remoteWorkType?: 'session' | 'project';
  projectPricing?: {
    basePrice?: number;
    depositPercentage?: number;
    estimatedDeliveryDays?: number;
    revisionsIncluded?: number;
    revisionPrice?: number;
  };
  acceptedFileTypes?: string[];
  maxFileSize?: number;
  maxFilesPerProject?: number;
  // Policies
  [key: string]: any; // Allow additional properties from form
}

export const EditItemForm = () => {
  const { itemId } = useParams();
  const { data: item } = useItem(itemId || '');
  const { data: studioData } = useStudio(item?.studioId || '');
  const studio = studioData?.currStudio;
  const { data: existingAddOns = [] } = useAddOns(itemId);
  const { t } = useTranslation(['forms', 'common']);
  const [searchParams] = useSearchParams();
  const [selectedLanguage, setSelectedLanguage] = useState<'en' | 'he'>('en');
  const hasPopulatedAddOns = useRef(false);

  // Unique formId per item to prevent autoSave data from one item bleeding into another
  const formId = `edit-item-form-${itemId}`;

  // Clear autoSave data for this item when component mounts to ensure fresh data from API
  useEffect(() => {
    if (itemId) {
      clearAllFormData(formId);
    }
  }, [itemId, formId]);

  const musicCategories = useMusicCategories();
  const musicSubCategories = useMusicSubCategories();
  const photoCategories = usePhotoCategories();
  const photoSubCategories = usePhotoSubCategories();
  const genres = useMusicGenres();
  const { getEnglishByDisplay } = useCategories();
  const { getEnglishByDisplay: getGenreEnglishByDisplay } = useGenres();

  const updateItemMutation = useUpdateItemMutation(itemId || '', item?.studioId);
  const deleteAddOnMutation = useDeleteAddOnMutation();
  const queryClient = useQueryClient();

  const [selectedCategories, setSelectedCategories] = useState<string[]>(
    item?.categories && item.categories.length > 0 ? [item.categories[0]] : musicCategories
  );
  const [selectedSubCategories, setSelectedSubCategories] = useState<string[]>(item?.subCategories || []);
  const [selectedGenres, setSelectedGenres] = useState<string[]>(item?.genres || []);
  const [subCategories, setSubCategories] = useState<string[]>(musicSubCategories);
  const [imageUrl] = useState<string>(item?.imageUrl || '');
  const [pricePer, setPricePer] = useState<string>(item?.pricePer || 'hour');
  const [price, setPrice] = useState<number | undefined>(item?.price);
  const [blockDiscounts, setBlockDiscounts] = useState<{ eightHour?: number; twelveHour?: number }>(
    item?.blockDiscounts || {}
  );
  // Pending add-ons without _id (will be generated by backend)
  const [pendingAddOns, setPendingAddOns] = useState<PendingAddOn[]>([]);

  // Booking Settings State - Initialize from item data
  const [minimumBookingDuration, setMinimumBookingDuration] = useState<Duration>(item?.minimumBookingDuration || {});
  const [minimumQuantity, setMinimumQuantity] = useState<number | undefined>(item?.minimumQuantity);
  const [advanceBookingRequired, setAdvanceBookingRequired] = useState<Duration>(item?.advanceBookingRequired || {});
  const [preparationTime, setPreparationTime] = useState<Duration>(item?.preparationTime || {});
  const [instantBook, setInstantBook] = useState<boolean>(item?.instantBook || false);

  // Remote Project Settings State - Initialize from item data
  const [remoteService, setRemoteService] = useState<boolean>(item?.remoteService || false);
  const [remoteWorkType, setRemoteWorkType] = useState<'session' | 'project'>(item?.remoteWorkType || 'project');
  const [projectPricing, setProjectPricing] = useState<{
    basePrice?: number;
    depositPercentage?: number;
    estimatedDeliveryDays?: number;
    revisionsIncluded?: number;
    revisionPrice?: number;
  }>(item?.projectPricing || {
    depositPercentage: 50,
    estimatedDeliveryDays: 7,
    revisionsIncluded: 2
  });
  const [acceptedFileTypes, setAcceptedFileTypes] = useState<string[]>(
    item?.acceptedFileTypes || ['.wav', '.mp3', '.aif', '.flac', '.zip']
  );
  const [maxFileSize, setMaxFileSize] = useState<number>(item?.maxFileSize || 500);
  const [maxFilesPerProject, setMaxFilesPerProject] = useState<number>(item?.maxFilesPerProject || 20);

  // Populate pending add-ons with existing add-ons when they're loaded
  useEffect(() => {
    if (existingAddOns.length > 0 && !hasPopulatedAddOns.current) {
      // Convert AddOn[] to PendingAddOn[] (keeping _id since it's optional in PendingAddOn)
      const pendingAddOnsFromExisting: PendingAddOn[] = existingAddOns.map((addOn) => ({
        ...addOn,
        _id: addOn._id // Keep the _id so we know these are existing add-ons
      }));
      setPendingAddOns(pendingAddOnsFromExisting);
      hasPopulatedAddOns.current = true;
    }
  }, [existingAddOns]);

  const handleCategoryChange = (values: string[]) => {
    setSelectedCategories(values);
    const newSubCategories = values.includes(`${musicCategories}`) ? musicSubCategories : photoSubCategories;
    setSubCategories(newSubCategories);
    setSelectedSubCategories([newSubCategories[0]]);
  };

  const handleSubCategoryChange = (values: string[]) => {
    setSelectedSubCategories(values);
  };

  const handleGenreChange = (values: string[]) => {
    setSelectedGenres(values);
  };

  const handleAddAddOn = useCallback((addOn: PendingAddOn) => {
    setPendingAddOns((prev) => [...prev, addOn]);
  }, []);

  const handleRemoveAddOn = useCallback(
    (index: number) => {
      const addOnToRemove = pendingAddOns[index];

      // If it's an existing add-on (has _id), delete it from backend
      if (addOnToRemove._id) {
        deleteAddOnMutation.mutate(addOnToRemove._id, {
          onSuccess: () => {
            // Remove from local state after successful deletion
            setPendingAddOns((prev) => prev.filter((_, i) => i !== index));
            toast.success(t('common:toasts.success.addOnDeleted'));
          },
          onError: (error) => {
            console.error('Error deleting add-on:', error);
            toast.error(t('common:toasts.error.addOnDeleteFailed'));
          }
        });
      } else {
        // If it's a new add-on (no _id), just remove from local state
        setPendingAddOns((prev) => prev.filter((_, i) => i !== index));
      }
    },
    [pendingAddOns, deleteAddOnMutation]
  );

  const handleUpdateAddOn = useCallback(
    async (index: number, updatedAddOn: PendingAddOn) => {
      const existingAddOn = pendingAddOns[index];

      // If it's an existing add-on (has _id), update it in backend
      if (existingAddOn._id && updatedAddOn._id) {
        try {
          await updateAddOn(existingAddOn._id, updatedAddOn as any);
          // Update local state after successful update
          setPendingAddOns((prev) => prev.map((addOn, i) => (i === index ? updatedAddOn : addOn)));

          // Invalidate queries to refresh data
          await queryClient.invalidateQueries({ queryKey: ['addOn', existingAddOn._id] });
          await queryClient.invalidateQueries({ queryKey: ['addOns'] });
          if (itemId) {
            await queryClient.invalidateQueries({ queryKey: ['addOns', 'item', itemId] });
            await queryClient.invalidateQueries({ queryKey: ['item', itemId] });
            await queryClient.invalidateQueries({ queryKey: ['items', {}] });
          }

          toast.success(t('common:toasts.success.addOnUpdated'));
        } catch (error) {
          console.error('Error updating add-on:', error);
          toast.error(t('common:toasts.error.addOnUpdateFailed'));
        }
      } else {
        // If it's a new add-on, just update local state
        setPendingAddOns((prev) => prev.map((addOn, i) => (i === index ? updatedAddOn : addOn)));
      }
    },
    [pendingAddOns, queryClient, itemId]
  );

  const pricePerOptions = [
    { value: 'hour', label: t('form.pricePer.hour') },
    { value: 'session', label: t('form.pricePer.session') },
    { value: 'unit', label: t('form.pricePer.unit') },
    { value: 'song', label: t('form.pricePer.song') },
    { value: 'project', label: t('form.pricePer.project') },
    { value: 'day', label: t('form.pricePer.day') }
  ];

  // Use English values for options (what gets submitted)
  const pricePerValues = pricePerOptions.map((option) => option.value);

  // Helper to get display label for a value
  const getPricePerLabel = (value: string) => {
    const option = pricePerOptions.find((opt) => opt.value === value);
    return option ? option.label : value;
  };

  // Pricing custom content
  const pricingContent = useMemo(
    () => (
      <div className="pricing-step">
        <div className="pricing-step__section">
          {/* Pricing Type Radio Buttons */}
          <div className="pricing-step__field pricing-step__field--full">
            <label className="pricing-step__label">
              {t('form.pricing.pricePerLabel', { defaultValue: 'Price per' })}
            </label>
            <div className="pricing-step__radio-group">
              {pricePerOptions.map((option) => (
                <button
                  key={option.value}
                  type="button"
                  onClick={() => setPricePer(option.value)}
                  className={`pricing-step__radio-btn ${pricePer === option.value ? 'pricing-step__radio-btn--active' : ''}`}
                >
                  {option.label}
                </button>
              ))}
            </div>
          </div>

          <div className="pricing-step__grid">
            {/* Price Input */}
            <div className="pricing-step__field">
              <label className="pricing-step__label">{t('form.pricing.priceLabel', { defaultValue: 'Price' })}</label>
              <div className="pricing-step__input-wrapper">
                <span className="pricing-step__input-prefix">â‚ª</span>
                <input
                  type="number"
                  name="price"
                  placeholder="0.00"
                  value={price ?? ''}
                  onChange={(e) => setPrice(e.target.value ? Number(e.target.value) : undefined)}
                  className="pricing-step__input pricing-step__input--with-prefix pricing-step__input--with-suffix"
                />
                <span className="pricing-step__input-suffix">
                  {t(`form.pricing.per.${pricePer}`, { defaultValue: `/ ${pricePer}` })}
                </span>
              </div>
            </div>

            {/* Minimum Booking Duration - Only show for hourly pricing */}
            {pricePer === 'hour' && (
              <div className="pricing-step__field">
                <label className="pricing-step__label">
                  {t('form.pricing.minimumBooking', { defaultValue: 'Minimum Booking' })}
                </label>
                <div className="pricing-step__input-wrapper">
                  <input
                    type="number"
                    name="minimumBookingDuration"
                    placeholder="1"
                    min={1}
                    value={minimumBookingDuration.value ?? ''}
                    onChange={(e) =>
                      setMinimumBookingDuration({
                        value: e.target.value ? Number(e.target.value) : undefined,
                        unit: 'hours'
                      })
                    }
                    className="pricing-step__input pricing-step__input--with-suffix"
                  />
                  <span className="pricing-step__input-suffix">
                    {t('form.pricing.hours', { defaultValue: 'hours' })}
                  </span>
                </div>
              </div>
            )}
          </div>

          {/* Block Discounts - Only show for hourly pricing */}
          {pricePer === 'hour' && (
            <div className="pricing-step__block-discounts">
              <div className="pricing-step__block-discounts-header">
                <OfferIcon className="pricing-step__block-discounts-icon" />
                <span className="pricing-step__block-discounts-title">
                  {t('form.pricing.blockDiscounts.title', { defaultValue: 'Block Discounts (Optional)' })}
                </span>
              </div>
              <div className="pricing-step__grid">
                <div className="pricing-step__field">
                  <label className="pricing-step__label">
                    {t('form.pricing.blockDiscounts.eightHour', { defaultValue: '8 Hour Block Price' })}
                  </label>
                  <div className="pricing-step__input-wrapper">
                    <span className="pricing-step__input-prefix">â‚ª</span>
                    <input
                      type="number"
                      placeholder={t('form.pricing.blockDiscounts.placeholder', { defaultValue: 'Discounted total' })}
                      value={blockDiscounts.eightHour ?? ''}
                      onChange={(e) =>
                        setBlockDiscounts((prev) => ({
                          ...prev,
                          eightHour: e.target.value ? Number(e.target.value) : undefined
                        }))
                      }
                      className="pricing-step__input pricing-step__input--with-prefix pricing-step__input--with-suffix"
                    />
                    <span className="pricing-step__input-suffix">
                      {t('form.pricing.blockDiscounts.total', { defaultValue: 'total' })}
                    </span>
                  </div>
                </div>
                <div className="pricing-step__field">
                  <label className="pricing-step__label">
                    {t('form.pricing.blockDiscounts.twelveHour', { defaultValue: '12 Hour Block Price' })}
                  </label>
                  <div className="pricing-step__input-wrapper">
                    <span className="pricing-step__input-prefix">â‚ª</span>
                    <input
                      type="number"
                      placeholder={t('form.pricing.blockDiscounts.placeholder', { defaultValue: 'Discounted total' })}
                      value={blockDiscounts.twelveHour ?? ''}
                      onChange={(e) =>
                        setBlockDiscounts((prev) => ({
                          ...prev,
                          twelveHour: e.target.value ? Number(e.target.value) : undefined
                        }))
                      }
                      className="pricing-step__input pricing-step__input--with-prefix pricing-step__input--with-suffix"
                    />
                    <span className="pricing-step__input-suffix">
                      {t('form.pricing.blockDiscounts.total', { defaultValue: 'total' })}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Commission Info Note */}
        <div className="pricing-step__info-box">
          <InfoOutlinedIcon className="pricing-step__info-icon" />
          <div className="pricing-step__info-content">
            <h4 className="pricing-step__info-title">
              {t('form.pricing.platformFee.title', { defaultValue: 'Platform Fee' })}
            </h4>
            <p className="pricing-step__info-text">
              {t('form.pricing.platformFee.description', {
                defaultValue:
                  'StudioZ takes a 9% commission on confirmed bookings. Your payout will be calculated automatically.'
              })}
            </p>
          </div>
        </div>
      </div>
    ),
    [t, pricePer, price, blockDiscounts, pricePerOptions, minimumBookingDuration]
  );

  // Booking Settings custom content
  const bookingSettingsContent = useMemo(
    () => (
      <div className="booking-settings-step">
        {/* Booking Mode Selection */}
        <div className="booking-settings-step__mode-grid">
          <button
            type="button"
            onClick={() => setInstantBook(false)}
            className={`booking-settings-step__mode-card ${!instantBook ? 'booking-settings-step__mode-card--active' : ''}`}
          >
            <div
              className={`booking-settings-step__mode-icon ${!instantBook ? 'booking-settings-step__mode-icon--active' : 'booking-settings-step__mode-icon--default'}`}
            >
              <EventAvailableIcon />
            </div>
            <h3
              className={`booking-settings-step__mode-title ${!instantBook ? 'booking-settings-step__mode-title--active' : 'booking-settings-step__mode-title--default'}`}
            >
              {t('form.bookingSettings.requestToBook.title', { defaultValue: 'Request to Book' })}
            </h3>
            <p className="booking-settings-step__mode-description">
              {t('form.bookingSettings.requestToBook.description', {
                defaultValue:
                  'Review every booking request before accepting. Best for studios that need to screen clients.'
              })}
            </p>
          </button>

          <button
            type="button"
            onClick={() => setInstantBook(true)}
            className={`booking-settings-step__mode-card ${instantBook ? 'booking-settings-step__mode-card--active' : ''}`}
          >
            <div
              className={`booking-settings-step__mode-icon ${instantBook ? 'booking-settings-step__mode-icon--active' : 'booking-settings-step__mode-icon--default'}`}
            >
              <BoltIcon />
            </div>
            <h3
              className={`booking-settings-step__mode-title ${instantBook ? 'booking-settings-step__mode-title--active' : 'booking-settings-step__mode-title--default'}`}
            >
              {t('form.bookingSettings.instantBook.title', { defaultValue: 'Instant Book' })}
            </h3>
            <p className="booking-settings-step__mode-description">
              {t('form.bookingSettings.instantBook.description', {
                defaultValue: 'Allow users to book instantly without approval. Gets 2x more bookings on average.'
              })}
            </p>
          </button>
        </div>

        {/* Settings Dropdowns */}
        <div className="booking-settings-step__settings-grid">
          <div className="booking-settings-step__field">
            <label className="booking-settings-step__label">
              {t('form.bookingSettings.advanceNotice.label', { defaultValue: 'Advance Notice' })}
              <HourglassIcon />
            </label>
            <div className="booking-settings-step__select-wrapper">
              <select
                className="booking-settings-step__select"
                value={
                  advanceBookingRequired.value && advanceBookingRequired.unit
                    ? `${advanceBookingRequired.value}-${advanceBookingRequired.unit}`
                    : '1-hours'
                }
                onChange={(e) => {
                  const [value, unit] = e.target.value.split('-');
                  setAdvanceBookingRequired({ value: parseInt(value), unit: unit as 'hours' | 'days' });
                }}
              >
                <option value="1-hours">
                  {t('form.bookingSettings.advanceNotice.options.1hour', {
                    defaultValue: 'At least 1 hour in advance'
                  })}
                </option>
                <option value="24-hours">
                  {t('form.bookingSettings.advanceNotice.options.24hours', {
                    defaultValue: 'At least 24 hours in advance'
                  })}
                </option>
                <option value="48-hours">
                  {t('form.bookingSettings.advanceNotice.options.48hours', {
                    defaultValue: 'At least 48 hours in advance'
                  })}
                </option>
                <option value="3-days">
                  {t('form.bookingSettings.advanceNotice.options.3days', {
                    defaultValue: 'At least 3 days in advance'
                  })}
                </option>
              </select>
              <span className="booking-settings-step__select-arrow">â–¼</span>
            </div>
          </div>

          <div className="booking-settings-step__field">
            <label className="booking-settings-step__label">
              {t('form.bookingSettings.preparationTime.label', { defaultValue: 'Preparation Time (Buffer)' })}
            </label>
            <div className="booking-settings-step__select-wrapper">
              <select
                className="booking-settings-step__select"
                value={
                  preparationTime.value && preparationTime.unit
                    ? `${preparationTime.value}-${preparationTime.unit}`
                    : '0'
                }
                onChange={(e) => {
                  if (e.target.value === '0') {
                    setPreparationTime({});
                  } else {
                    const [value, unit] = e.target.value.split('-');
                    setPreparationTime({ value: parseInt(value), unit: unit as 'hours' | 'days' });
                  }
                }}
              >
                <option value="0">
                  {t('form.bookingSettings.preparationTime.options.none', { defaultValue: 'None' })}
                </option>
                <option value="1-hours">
                  {t('form.bookingSettings.preparationTime.options.1hour', { defaultValue: '1 hour' })}
                </option>
                <option value="2-hours">
                  {t('form.bookingSettings.preparationTime.options.2hours', { defaultValue: '2 hours' })}
                </option>
                <option value="3-hours">
                  {t('form.bookingSettings.preparationTime.options.3hours', { defaultValue: '3 hours' })}
                </option>
              </select>
              <span className="booking-settings-step__select-arrow">â–¼</span>
            </div>
          </div>
        </div>

        {/* Minimum Quantity - only for non-hourly pricing */}
        {pricePer !== 'hour' && (
          <div className="booking-settings-step__field">
            <label className="booking-settings-step__label">{t('form.bookingSettings.minimumQuantity.label')}</label>
            <input
              type="number"
              name="minimumQuantity"
              value={minimumQuantity ?? ''}
              onChange={(e) => setMinimumQuantity(e.target.value ? Number(e.target.value) : undefined)}
              min={1}
              placeholder="1"
              className="booking-settings-step__input"
            />
          </div>
        )}
      </div>
    ),
    [t, pricePer, minimumQuantity, advanceBookingRequired, preparationTime, instantBook]
  );

  // Remote Project Settings custom content
  const remoteSettingsContent = useMemo(
    () => (
      <div className="remote-settings-step">
        {/* Remote Service Toggle */}
        <div className="remote-settings-step__toggle-section">
          <div className="remote-settings-step__toggle-header">
            <PublicIcon className="remote-settings-step__toggle-icon" />
            <div className="remote-settings-step__toggle-info">
              <h3 className="remote-settings-step__toggle-title">
                {t('form.remoteSettings.enableRemote.title', { defaultValue: 'Enable Remote Services' })}
              </h3>
              <p className="remote-settings-step__toggle-description">
                {t('form.remoteSettings.enableRemote.description', {
                  defaultValue: 'Allow customers to request work remotely without visiting your studio'
                })}
              </p>
            </div>
          </div>
          <button
            type="button"
            onClick={() => setRemoteService(!remoteService)}
            className={`remote-settings-step__toggle-btn ${remoteService ? 'remote-settings-step__toggle-btn--active' : ''}`}
            aria-pressed={remoteService}
          >
            <span className="remote-settings-step__toggle-slider" />
          </button>
        </div>

        {remoteService && (
          <>
            {/* Work Type Selection */}
            <div className="remote-settings-step__work-type">
              <label className="remote-settings-step__label">
                {t('form.remoteSettings.workType.label', { defaultValue: 'Remote Work Type' })}
              </label>
              <div className="remote-settings-step__radio-group">
                <button
                  type="button"
                  onClick={() => setRemoteWorkType('project')}
                  className={`remote-settings-step__radio-btn ${remoteWorkType === 'project' ? 'remote-settings-step__radio-btn--active' : ''}`}
                >
                  <UploadIcon />
                  <div>
                    <strong>{t('form.remoteSettings.workType.project', { defaultValue: 'Project-Based' })}</strong>
                    <span>{t('form.remoteSettings.workType.projectDesc', { defaultValue: 'Customer uploads files, you deliver results' })}</span>
                  </div>
                </button>
                <button
                  type="button"
                  onClick={() => setRemoteWorkType('session')}
                  className={`remote-settings-step__radio-btn ${remoteWorkType === 'session' ? 'remote-settings-step__radio-btn--active' : ''}`}
                >
                  <EventAvailableIcon />
                  <div>
                    <strong>{t('form.remoteSettings.workType.session', { defaultValue: 'Live Session' })}</strong>
                    <span>{t('form.remoteSettings.workType.sessionDesc', { defaultValue: 'Real-time collaboration via video call' })}</span>
                  </div>
                </button>
              </div>
            </div>

            {/* Project Pricing Section - only for project-based */}
            {remoteWorkType === 'project' && (
              <div className="remote-settings-step__pricing-section">
                <h4 className="remote-settings-step__section-title">
                  {t('form.remoteSettings.projectPricing.title', { defaultValue: 'Project Pricing' })}
                </h4>
                
                <div className="remote-settings-step__grid">
                  {/* Base Price */}
                  <div className="remote-settings-step__field">
                    <label className="remote-settings-step__label">
                      {t('form.remoteSettings.projectPricing.basePrice', { defaultValue: 'Base Price' })}
                    </label>
                    <div className="remote-settings-step__input-wrapper">
                      <span className="remote-settings-step__input-prefix">â‚ª</span>
                      <input
                        type="number"
                        placeholder="0"
                        value={projectPricing.basePrice ?? ''}
                        onChange={(e) =>
                          setProjectPricing((prev) => ({
                            ...prev,
                            basePrice: e.target.value ? Number(e.target.value) : undefined
                          }))
                        }
                        className="remote-settings-step__input remote-settings-step__input--with-prefix"
                      />
                    </div>
                  </div>

                  {/* Deposit Percentage */}
                  <div className="remote-settings-step__field">
                    <label className="remote-settings-step__label">
                      {t('form.remoteSettings.projectPricing.deposit', { defaultValue: 'Deposit Required' })}
                    </label>
                    <div className="remote-settings-step__input-wrapper">
                      <input
                        type="number"
                        min={0}
                        max={100}
                        placeholder="50"
                        value={projectPricing.depositPercentage ?? ''}
                        onChange={(e) =>
                          setProjectPricing((prev) => ({
                            ...prev,
                            depositPercentage: e.target.value ? Number(e.target.value) : undefined
                          }))
                        }
                        className="remote-settings-step__input remote-settings-step__input--with-suffix"
                      />
                      <span className="remote-settings-step__input-suffix">%</span>
                    </div>
                  </div>

                  {/* Estimated Delivery Days */}
                  <div className="remote-settings-step__field">
                    <label className="remote-settings-step__label">
                      {t('form.remoteSettings.projectPricing.deliveryDays', { defaultValue: 'Delivery Time' })}
                    </label>
                    <div className="remote-settings-step__input-wrapper">
                      <input
                        type="number"
                        min={1}
                        placeholder="7"
                        value={projectPricing.estimatedDeliveryDays ?? ''}
                        onChange={(e) =>
                          setProjectPricing((prev) => ({
                            ...prev,
                            estimatedDeliveryDays: e.target.value ? Number(e.target.value) : undefined
                          }))
                        }
                        className="remote-settings-step__input remote-settings-step__input--with-suffix"
                      />
                      <span className="remote-settings-step__input-suffix">
                        {t('form.remoteSettings.projectPricing.days', { defaultValue: 'days' })}
                      </span>
                    </div>
                  </div>

                  {/* Revisions Included */}
                  <div className="remote-settings-step__field">
                    <label className="remote-settings-step__label">
                      {t('form.remoteSettings.projectPricing.revisions', { defaultValue: 'Revisions Included' })}
                    </label>
                    <div className="remote-settings-step__input-wrapper">
                      <input
                        type="number"
                        min={0}
                        placeholder="2"
                        value={projectPricing.revisionsIncluded ?? ''}
                        onChange={(e) =>
                          setProjectPricing((prev) => ({
                            ...prev,
                            revisionsIncluded: e.target.value ? Number(e.target.value) : undefined
                          }))
                        }
                        className="remote-settings-step__input"
                      />
                    </div>
                  </div>

                  {/* Extra Revision Price */}
                  <div className="remote-settings-step__field">
                    <label className="remote-settings-step__label">
                      {t('form.remoteSettings.projectPricing.revisionPrice', { defaultValue: 'Extra Revision Price' })}
                    </label>
                    <div className="remote-settings-step__input-wrapper">
                      <span className="remote-settings-step__input-prefix">â‚ª</span>
                      <input
                        type="number"
                        placeholder="0"
                        value={projectPricing.revisionPrice ?? ''}
                        onChange={(e) =>
                          setProjectPricing((prev) => ({
                            ...prev,
                            revisionPrice: e.target.value ? Number(e.target.value) : undefined
                          }))
                        }
                        className="remote-settings-step__input remote-settings-step__input--with-prefix"
                      />
                    </div>
                  </div>
                </div>

                {/* File Settings */}
                <h4 className="remote-settings-step__section-title" style={{ marginTop: '1.5rem' }}>
                  {t('form.remoteSettings.fileSettings.title', { defaultValue: 'File Upload Settings' })}
                </h4>
                
                <div className="remote-settings-step__grid">
                  {/* Max File Size */}
                  <div className="remote-settings-step__field">
                    <label className="remote-settings-step__label">
                      {t('form.remoteSettings.fileSettings.maxSize', { defaultValue: 'Max File Size' })}
                    </label>
                    <div className="remote-settings-step__input-wrapper">
                      <input
                        type="number"
                        min={1}
                        placeholder="500"
                        value={maxFileSize ?? ''}
                        onChange={(e) => setMaxFileSize(e.target.value ? Number(e.target.value) : 500)}
                        className="remote-settings-step__input remote-settings-step__input--with-suffix"
                      />
                      <span className="remote-settings-step__input-suffix">MB</span>
                    </div>
                  </div>

                  {/* Max Files Per Project */}
                  <div className="remote-settings-step__field">
                    <label className="remote-settings-step__label">
                      {t('form.remoteSettings.fileSettings.maxFiles', { defaultValue: 'Max Files Per Project' })}
                    </label>
                    <div className="remote-settings-step__input-wrapper">
                      <input
                        type="number"
                        min={1}
                        placeholder="20"
                        value={maxFilesPerProject ?? ''}
                        onChange={(e) => setMaxFilesPerProject(e.target.value ? Number(e.target.value) : 20)}
                        className="remote-settings-step__input"
                      />
                    </div>
                  </div>
                </div>

                {/* Accepted File Types */}
                <div className="remote-settings-step__field" style={{ marginTop: '1rem' }}>
                  <label className="remote-settings-step__label">
                    {t('form.remoteSettings.fileSettings.acceptedTypes', { defaultValue: 'Accepted File Types' })}
                  </label>
                  <div className="remote-settings-step__file-types">
                    {['.wav', '.mp3', '.aif', '.aiff', '.flac', '.zip', '.rar', '.pdf', '.mid', '.stems'].map((type) => (
                      <button
                        key={type}
                        type="button"
                        onClick={() => {
                          setAcceptedFileTypes((prev) =>
                            prev.includes(type) ? prev.filter((t) => t !== type) : [...prev, type]
                          );
                        }}
                        className={`remote-settings-step__file-type-btn ${acceptedFileTypes.includes(type) ? 'remote-settings-step__file-type-btn--active' : ''}`}
                      >
                        {type}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* Info Box */}
            <div className="remote-settings-step__info-box">
              <InfoOutlinedIcon className="remote-settings-step__info-icon" />
              <div className="remote-settings-step__info-content">
                <h4 className="remote-settings-step__info-title">
                  {t('form.remoteSettings.info.title', { defaultValue: 'How Remote Projects Work' })}
                </h4>
                <p className="remote-settings-step__info-text">
                  {remoteWorkType === 'project'
                    ? t('form.remoteSettings.info.projectDesc', {
                        defaultValue:
                          'Customers submit a project request with their requirements and files. You review, accept, and deliver the completed work through the platform.'
                      })
                    : t('form.remoteSettings.info.sessionDesc', {
                        defaultValue:
                          'Customers book a time slot for a live remote session. You connect via video call to collaborate in real-time.'
                      })}
                </p>
              </div>
            </div>
          </>
        )}
      </div>
    ),
    [t, remoteService, remoteWorkType, projectPricing, acceptedFileTypes, maxFileSize, maxFilesPerProject]
  );

  // Define form steps with Zod schemas
  const steps: FormStep[] = useMemo(
    () => [
      {
        id: 'basic-info',
        title: t('form.steps.basicInfo') || 'Basic Information',
        description: t('form.steps.basicInfoDesc') || 'Enter your item name and description',
        fieldNames: ['basicInfoHeader', 'languageToggle', 'name.en', 'name.he', 'description.en', 'description.he'],
        schema: itemStepSchemasEdit['basic-info'],
        languageToggle: true,
        icon: InfoOutlinedIcon
      },
      {
        id: 'categories',
        title: t('form.steps.categories') || 'Categories & Genres',
        description: t('form.steps.categoriesDesc') || 'Select categories and genres',
        fieldNames: ['categoriesHeader', 'categories', 'subCategories', 'genresHeader', 'genres'],
        schema: itemStepSchemasEdit.categories,
        icon: CategoryIcon
      },
      {
        id: 'pricing',
        title: t('form.steps.pricing') || 'Pricing & Options',
        description: t('form.steps.pricingDesc') || 'Set price and booking options',
        fieldNames: ['price', 'pricePer', 'blockDiscounts', 'minimumBookingDuration'],
        schema: itemStepSchemasEdit.pricing,
        customContent: pricingContent,
        icon: OfferIcon
      },
      {
        id: 'booking-settings',
        title: t('form.steps.bookingSettings') || 'Booking Settings',
        description: t('form.steps.bookingSettingsDesc') || 'Set booking rules and preparation times',
        fieldNames: ['minimumQuantity', 'advanceBookingRequired', 'preparationTime'],
        schema: itemStepSchemasEdit['booking-settings'],
        customContent: bookingSettingsContent,
        icon: CalendarIcon
      },
      {
        id: 'remote-settings',
        title: t('form.steps.remoteSettings') || 'Remote Services',
        description: t('form.steps.remoteSettingsDesc') || 'Enable and configure remote project options',
        fieldNames: ['remoteService', 'remoteWorkType', 'projectPricing'],
        schema: itemStepSchemasEdit['remote-settings'],
        icon: PublicIcon,
        customContent: remoteSettingsContent
      },
      ...(isFeatureEnabled('addOns')
        ? [
            {
              id: 'add-ons',
              title: t('form.steps.addOns') || 'Add-Ons',
              description: t('form.steps.addOnsDesc') || 'Add optional add-ons to your item',
              fieldNames: [],
              schema: itemStepSchemasEdit['add-ons'],
              icon: InventoryIcon,
              customContent: (
                <CreateAddOnForm
                  mode="local"
                  onAdd={handleAddAddOn}
                  onRemove={handleRemoveAddOn}
                  onUpdate={handleUpdateAddOn}
                  pendingAddOns={pendingAddOns}
                />
              )
            }
          ]
        : [])
    ],
    [t, pendingAddOns, handleAddAddOn, handleRemoveAddOn, handleUpdateAddOn, pricingContent, bookingSettingsContent, remoteSettingsContent]
  );

  // Initialize currentStepIndex from URL on mount
  const [currentStepIndex, setCurrentStepIndex] = useState(0);

  // Initialize and sync currentStepIndex with URL
  useEffect(() => {
    const urlStepIndex = getStepFromUrl(searchParams, steps);
    setCurrentStepIndex(urlStepIndex);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [searchParams]);

  // Reset language when step changes
  useEffect(() => {
    setSelectedLanguage('en');
  }, [currentStepIndex]);

  const fields = [
    {
      name: 'basicInfoHeader',
      label: t('form.itemSections.basicInfo') || 'Service Details',
      subtitle:
        t('form.itemSections.basicInfoDesc') ||
        'Give your service a compelling name and description to attract clients.',
      type: 'sectionHeader' as FieldType,
      icon: InfoOutlinedIcon
    },
    {
      name: 'name.en',
      label: `${t('form.name.en')} ðŸ‡ºðŸ‡¸`,
      type: 'text' as FieldType,
      value: item?.name.en,
      placeholder: t('form.name.placeholder', { defaultValue: 'e.g. The Sound Garden' }),
      helperText: t('form.name.helperText'),
      maxLength: ITEM_NAME_MAX,
      showCharCounter: true
    },
    {
      name: 'name.he',
      label: `${t('form.name.he')} ðŸ‡®ðŸ‡±`,
      type: 'text' as FieldType,
      value: item?.name.he,
      placeholder: t('form.name.placeholderHe', { defaultValue: '×œ×“×•×’×ž×”: ×’×Ÿ ×”×¦×œ×™×œ×™×' }),
      helperText: t('form.name.helperText'),
      maxLength: ITEM_NAME_MAX,
      showCharCounter: true
    },
    {
      name: 'description.en',
      label: `${t('form.description.en')} ðŸ‡ºðŸ‡¸`,
      type: 'textarea' as FieldType,
      value: item?.description?.en,
      placeholder: t('form.description.placeholder', {
        defaultValue: "Describe your studio's vibe, equipment, and what makes it unique..."
      }),
      helperText: t('form.description.helperText'),
      maxLength: ITEM_DESCRIPTION_MAX,
      showCharCounter: true
    },
    {
      name: 'description.he',
      label: `${t('form.description.he')} ðŸ‡®ðŸ‡±`,
      type: 'textarea' as FieldType,
      value: item?.description?.he,
      placeholder: t('form.description.placeholderHe', {
        defaultValue: '×ª××¨×• ××ª ×”××•×•×™×¨×”, ×”×¦×™×•×“ ×•×ž×” ×©×ž×™×™×—×“ ××ª ×”×¡×˜×•×“×™×• ×©×œ×›×...'
      }),
      helperText: t('form.description.helperText'),
      maxLength: ITEM_DESCRIPTION_MAX,
      showCharCounter: true
    },
    {
      name: 'languageToggle',
      label: t('form.languageToggle.label') || 'Select language for editing',
      type: 'languageToggle' as FieldType,
      value: selectedLanguage,
      onChange: setSelectedLanguage
    },
    {
      name: 'categoriesHeader',
      label: t('form.itemSections.categories') || 'Service Category',
      subtitle: t('form.itemSections.categoriesDesc') || 'Choose the category that best describes your service.',
      type: 'sectionHeader' as FieldType,
      icon: CategoryIcon
    },
    {
      name: 'categories',
      label: t('form.categories.label'),
      type: 'select' as FieldType,
      options: [musicCategories, photoCategories],
      value: selectedCategories,
      onChange: handleCategoryChange
    },
    {
      name: 'subCategories',
      label: '',
      type: 'multiSelect' as FieldType,
      options: subCategories,
      value: selectedSubCategories,
      onChange: handleSubCategoryChange,
      initialVisibleCount: 12,
      showAllLabel: t('form.subCategories.showAll', 'Show All'),
      showLessLabel: t('form.subCategories.showLess', 'Show Less'),
      className: 'subcategories-plain'
    },
    {
      name: 'genresHeader',
      label: t('form.sections.genres') || 'Genres',
      subtitle: t('form.sections.genresDesc') || 'Select the music styles you specialize in.',
      type: 'sectionHeader' as FieldType,
      icon: LibraryMusicIcon
    },
    {
      name: 'genres',
      label: '',
      type: 'multiSelect' as FieldType,
      options: genres,
      value: selectedGenres,
      onChange: handleGenreChange,
      bubbleStyle: true,
      initialVisibleCount: 14,
      showAllLabel: t('form.genres.showAll', { defaultValue: 'Show All' }),
      showLessLabel: t('form.genres.showLess', { defaultValue: 'Show Less' })
    },
    {
      name: 'price',
      label: t('form.price.label'),
      type: 'number' as FieldType,
      value: item?.price,
      helperText: t('form.price.helperText')
    },
    {
      name: 'pricePer',
      label: t('form.pricePer.label'),
      type: 'select' as FieldType,
      options: pricePerValues,
      value: pricePer,
      displayValue: getPricePerLabel(pricePer),
      getOptionLabel: getPricePerLabel,
      onChange: (value: string) => setPricePer(value)
    }
  ];

  const handleSubmit = async (formData: ItemFormData) => {
    // Convert subCategories and genres to English values for consistent database storage
    const englishSubCategories = selectedSubCategories.map((subCat) => getEnglishByDisplay(subCat));
    const englishGenres = selectedGenres.map((genre) => getGenreEnglishByDisplay(genre));

    formData.imageUrl = imageUrl;
    formData.categories = selectedCategories;
    formData.subCategories = englishSubCategories;
    formData.genres = englishGenres;
    formData.studioId = item?.studioId || '';
    formData.pricePer = pricePer;
    // Use the state value for price
    formData.price = price;
    // Add block discounts if set
    if (blockDiscounts.eightHour || blockDiscounts.twelveHour) {
      formData.blockDiscounts = blockDiscounts;
    }
    // Use the state value for instantBook
    formData.instantBook = instantBook;

    // Extract city from studio if item.city is not available
    if (!formData.city && !item?.city) {
      formData.city = studio?.city || '';
    } else if (!formData.city) {
      formData.city = item?.city || '';
    }

    // Ensure name and description objects are preserved
    formData.name = {
      en: formData.name?.en || item?.name?.en || '',
      he: formData.name?.he || item?.name?.he || ''
    };

    formData.description = {
      en: formData.description?.en || item?.description?.en || '',
      he: formData.description?.he || item?.description?.he || ''
    };

    // Add booking settings (only include if they have values)
    if (minimumBookingDuration.value && minimumBookingDuration.unit) {
      formData.minimumBookingDuration = minimumBookingDuration;
    }
    if (minimumQuantity !== undefined && minimumQuantity > 0) {
      formData.minimumQuantity = minimumQuantity;
    }
    if (advanceBookingRequired.value && advanceBookingRequired.unit) {
      formData.advanceBookingRequired = advanceBookingRequired;
    }
    if (preparationTime.value && preparationTime.unit) {
      formData.preparationTime = preparationTime;
    }

    // Add remote settings
    formData.remoteService = remoteService;
    if (remoteService) {
      formData.remoteWorkType = remoteWorkType;
      if (remoteWorkType === 'project') {
        // Only include projectPricing if it has values
        const hasProjectPricing = projectPricing.basePrice || projectPricing.depositPercentage || 
          projectPricing.estimatedDeliveryDays || projectPricing.revisionsIncluded;
        if (hasProjectPricing) {
          formData.projectPricing = projectPricing;
        }
        formData.acceptedFileTypes = acceptedFileTypes;
        formData.maxFileSize = maxFileSize;
        formData.maxFilesPerProject = maxFilesPerProject;
      }
    }

    // Remove UI-only fields that shouldn't be sent to the API
    delete formData.languageToggle;

    // Update item first, then batch create new add-ons (only ones without _id)
    updateItemMutation.mutate(formData as Item, {
      onSuccess: async () => {
        // Filter to only new add-ons (without _id) for batch creation
        const newAddOns = pendingAddOns.filter((addOn) => !addOn._id);

        if (newAddOns.length > 0 && itemId) {
          try {
            await createAddOnsBatch(itemId, newAddOns);
            // Note: The main success toast is shown by useMutationHandler
            // Remove created add-ons from pending list, keep existing ones
            setPendingAddOns((prev) => prev.filter((addOn) => addOn._id));
          } catch (error) {
            console.error('Error creating add-ons:', error);
            toast.error(t('common:toasts.error.itemUpdatedAddOnsFailed'));
          }
        }
        // Removed extra toast.success - useMutationHandler already shows the success toast
        // Invalidate addOns queries
        if (itemId) {
          await queryClient.invalidateQueries({ queryKey: ['addOns', 'item', itemId] });
        }
        await queryClient.invalidateQueries({ queryKey: ['addOns'] });
      }
    });
  };

  // Guard: Don't render form until item data is loaded
  // Must be after all hooks to maintain hook order
  if (!item) {
    return <div>Loading...</div>;
  }

  return (
    <section>
      <section className="form-wrapper edit-item-form-wrapper">
        <SteppedForm
          className="edit-item-form"
          formId={formId}
          steps={steps}
          fields={fields}
          onSubmit={handleSubmit}
          onCategoryChange={handleCategoryChange}
          submitButtonText={t('form.submit.editItem')}
          nextButtonText={t('form.buttons.next') || 'Next'}
          previousButtonText={t('form.buttons.previous') || 'Previous'}
          selectedLanguage={selectedLanguage}
          onLanguageChange={setSelectedLanguage}
          onStepChange={(current) => setCurrentStepIndex(current)}
        />
      </section>
    </section>
  );
};
